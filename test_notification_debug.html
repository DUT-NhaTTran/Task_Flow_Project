<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Debug Test - Enhanced</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; }
        .notification-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 4px solid #28a745; }
        .polling-status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .polling-active { background: #d4edda; color: #155724; }
        .polling-inactive { background: #f8d7da; color: #721c24; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Notification System Debug Tool - Enhanced</h1>
    
    <!-- Real-time Polling Test Section -->
    <div class="section">
        <h2>üîÑ Real-time Polling Test</h2>
        <div id="polling-status" class="polling-status polling-inactive">
            Polling: Inactive
        </div>
        <button class="button" onclick="startPolling()">Start Polling (5s interval)</button>
        <button class="button" onclick="stopPolling()">Stop Polling</button>
        <div>
            <label>Poll User ID: <input type="text" id="pollUserId" placeholder="Enter user ID to poll"></label>
        </div>
        <div id="polling-logs" class="log" style="height: 200px; overflow-y: scroll;"></div>
    </div>

    <!-- LocalStorage Debug Section -->
    <div class="section">
        <h2>üîç LocalStorage Debug</h2>
        <button class="button" onclick="checkLocalStorage()">Check All User IDs</button>
        <div id="localStorage-result" class="log"></div>
    </div>

    <!-- Manual API Test Section -->
    <div class="section">
        <h2>üì° Manual API Test</h2>
        <div>
            <label>User ID: <input type="text" id="testUserId" placeholder="Enter user ID"></label>
            <button class="button" onclick="testFetchNotifications()">Fetch Notifications</button>
        </div>
        <div id="api-result" class="log"></div>
    </div>

    <!-- Create Notification Test Section -->
    <div class="section">
        <h2>‚úâÔ∏è Create Test Notification</h2>
        <div>
            <label>Recipient User ID: <input type="text" id="recipientId" placeholder="Who should receive notification"></label><br>
            <label>Actor User ID: <input type="text" id="actorId" placeholder="Who is sending notification"></label><br>
            <label>Actor Name: <input type="text" id="actorName" placeholder="Actor display name"></label><br>
            <label>Type: 
                <select id="notificationType">
                    <option value="TASK_ASSIGNED">TASK_ASSIGNED</option>
                    <option value="TASK_REASSIGNED">TASK_REASSIGNED</option>
                    <option value="TASK_UPDATED">TASK_UPDATED</option>
                </select>
            </label><br>
            <button class="button" onclick="createTestNotification()">Create Test Notification</button>
        </div>
        <div id="create-result" class="log"></div>
    </div>

    <!-- Current Notifications Display -->
    <div class="section">
        <h2>üìã Current Notifications</h2>
        <button class="button" onclick="displayAllNotifications()">Refresh List</button>
        <div id="notifications-list"></div>
    </div>

    <script>
        let pollingInterval = null;
        let pollingUserId = null;
        let lastNotificationCount = 0;

        // Polling functions
        function startPolling() {
            const userId = document.getElementById('pollUserId').value.trim();
            if (!userId) {
                alert('Please enter a User ID to poll for notifications');
                return;
            }

            pollingUserId = userId;
            lastNotificationCount = 0;
            
            // Update status
            const statusDiv = document.getElementById('polling-status');
            statusDiv.textContent = `Polling: Active for User ${userId} (every 5 seconds)`;
            statusDiv.className = 'polling-status polling-active';

            // Log start
            logPolling(`üöÄ Started polling for user: ${userId} at ${new Date().toLocaleTimeString()}`);

            // Initial fetch
            pollNotifications();

            // Start interval
            pollingInterval = setInterval(pollNotifications, 5000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            const statusDiv = document.getElementById('polling-status');
            statusDiv.textContent = 'Polling: Inactive';
            statusDiv.className = 'polling-status polling-inactive';

            logPolling(`üõë Stopped polling at ${new Date().toLocaleTimeString()}`);
        }

        async function pollNotifications() {
            if (!pollingUserId) return;

            const timestamp = new Date().toLocaleTimeString();
            logPolling(`üîÑ Polling notifications at ${timestamp}...`);

            try {
                const response = await fetch(`http://localhost:8089/api/notifications/user/${pollingUserId}`);
                const data = await response.json();

                if (data && Array.isArray(data)) {
                    const currentCount = data.length;
                    
                    logPolling(`üìä Found ${currentCount} notifications (previous: ${lastNotificationCount})`);

                    if (lastNotificationCount > 0 && currentCount > lastNotificationCount) {
                        const newCount = currentCount - lastNotificationCount;
                        logPolling(`üîî NEW NOTIFICATIONS DETECTED: ${newCount} new notification(s)!`, 'success');
                        
                        // Show the new notifications
                        const newNotifications = data.slice(0, newCount);
                        newNotifications.forEach((notif, index) => {
                            logPolling(`   üì© New #${index + 1}: ${notif.title} - ${notif.message}`, 'info');
                        });
                    }

                    lastNotificationCount = currentCount;
                } else {
                    logPolling(`‚ùå API Error: ${data?.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                logPolling(`‚ùå Network Error: ${error.message}`, 'error');
            }
        }

        function logPolling(message, type = 'info') {
            const logsDiv = document.getElementById('polling-logs');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            if (type === 'success') logEntry.style.color = 'green';
            else if (type === 'error') logEntry.style.color = 'red';
            else if (type === 'info') logEntry.style.color = 'blue';
            
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Existing functions
        function checkLocalStorage() {
            const keys = ['ownerId', 'userId', 'currentUserId', 'user_id', 'id'];
            let result = '<h3>LocalStorage User ID Check:</h3>';
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                result += `<div><strong>${key}:</strong> ${value || 'Not found'}</div>`;
            });

            // Also check all localStorage keys that might contain user info
            result += '<h4>All localStorage keys:</h4>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                result += `<div><code>${key}: ${value}</code></div>`;
            }

            document.getElementById('localStorage-result').innerHTML = result;
        }

        async function testFetchNotifications() {
            const userId = document.getElementById('testUserId').value.trim();
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<div class="info">Fetching notifications...</div>';

            try {
                console.log('Fetching notifications for user:', userId);
                const response = await fetch(`http://localhost:8089/api/notifications/user/${userId}`);
                const data = await response.json();
                
                console.log('API Response:', data);

                let resultHtml = `<h3>API Response for User ID: ${userId}</h3>`;
                resultHtml += `<div><strong>Status:</strong> ${response.status}</div>`;
                resultHtml += `<div><strong>Response Type:</strong> ${Array.isArray(data) ? 'Array' : typeof data}</div>`;
                
                if (Array.isArray(data)) {
                    resultHtml += `<div class="success"><strong>Total Notifications:</strong> ${data.length}</div>`;
                    
                    if (data.length > 0) {
                        resultHtml += '<h4>Notifications:</h4>';
                        data.forEach((notification, index) => {
                            resultHtml += `
                                <div class="notification-item">
                                    <strong>#${index + 1}</strong><br>
                                    <strong>Type:</strong> ${notification.type}<br>
                                    <strong>Title:</strong> ${notification.title}<br>
                                    <strong>Message:</strong> ${notification.message}<br>
                                    <strong>Recipient:</strong> ${notification.recipientUserId}<br>
                                    <strong>Actor:</strong> ${notification.actorUserName} (${notification.actorUserId})<br>
                                    <strong>Created:</strong> ${new Date(notification.createdAt).toLocaleString()}<br>
                                    <strong>Read:</strong> ${notification.isRead ? 'Yes' : 'No'}
                                </div>
                            `;
                        });
                    } else {
                        resultHtml += '<div class="info">No notifications found</div>';
                    }
                } else {
                    resultHtml += `<div class="error">Unexpected response format:</div>`;
                    resultHtml += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }

                resultDiv.innerHTML = resultHtml;
            } catch (error) {
                console.error('Error fetching notifications:', error);
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function createTestNotification() {
            const recipientId = document.getElementById('recipientId').value.trim();
            const actorId = document.getElementById('actorId').value.trim();
            const actorName = document.getElementById('actorName').value.trim();
            const type = document.getElementById('notificationType').value;

            if (!recipientId || !actorId) {
                alert('Please enter both Recipient and Actor User IDs');
                return;
            }

            const notificationData = {
                type: type,
                title: type === 'TASK_ASSIGNED' ? 'Task assigned' : type === 'TASK_REASSIGNED' ? 'Task reassigned' : 'Task updated',
                message: `Test notification: You have been assigned to a test task`,
                recipientUserId: recipientId,
                actorUserId: actorId,
                actorUserName: actorName || 'Test User',
                projectId: 'test-project-123',
                taskId: 'test-task-456',
                actionUrl: '/test-url'
            };

            const resultDiv = document.getElementById('create-result');
            resultDiv.innerHTML = '<div class="info">Creating notification...</div>';

            try {
                console.log('Creating notification:', notificationData);
                const response = await fetch('http://localhost:8089/api/notifications/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(notificationData)
                });

                const data = await response.json();
                console.log('Create response:', data);

                if (response.ok && data.id) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Notification created successfully!</div>
                        <div><strong>ID:</strong> ${data.id}</div>
                        <div><strong>Type:</strong> ${data.type}</div>
                        <div><strong>Recipient:</strong> ${data.recipientUserId}</div>
                        <div><strong>Created At:</strong> ${new Date(data.createdAt).toLocaleString()}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed to create notification: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                console.error('Error creating notification:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function displayAllNotifications() {
            const resultDiv = document.getElementById('notifications-list');
            resultDiv.innerHTML = '<div class="info">Loading all notifications...</div>';

            try {
                // We'll try to get notifications for the current polling user or ask for a user ID
                let userId = pollingUserId;
                if (!userId) {
                    userId = prompt('Enter User ID to display notifications for:');
                    if (!userId) return;
                }

                const response = await fetch(`http://localhost:8089/api/notifications/user/${userId}`);
                const data = await response.json();

                if (Array.isArray(data)) {
                    let html = `<h3>All Notifications for User: ${userId}</h3>`;
                    html += `<div><strong>Total:</strong> ${data.length}</div>`;

                    if (data.length > 0) {
                        data.forEach((notification, index) => {
                            html += `
                                <div class="notification-item">
                                    <strong>#${index + 1}</strong> 
                                    <span style="color: ${notification.isRead ? 'green' : 'orange'};">
                                        ${notification.isRead ? '‚úÖ Read' : 'üü† Unread'}
                                    </span><br>
                                    <strong>${notification.title}</strong><br>
                                    ${notification.message}<br>
                                    <small>From: ${notification.actorUserName} | ${new Date(notification.createdAt).toLocaleString()}</small>
                                </div>
                            `;
                        });
                    } else {
                        html += '<div class="info">No notifications found</div>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Auto-check localStorage on page load
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html> 